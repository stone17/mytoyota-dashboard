<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trip History - MyToyota Dashboard</title>
    <link rel="stylesheet" href="/static/css/style.css?v={{ cache_buster }}">
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
    <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
    
    <style>
        .page-layout { margin: 20px auto; max-width: 1600px; }
        .controls-container { display: flex; flex-wrap: wrap; gap: 20px; margin-bottom: 20px; align-items: flex-start; }
        .collapsible-panel { flex: 1 1 300px; background: #fff; border: 1px solid #e0e0e0; border-radius: 8px; overflow: hidden; box-shadow: 0 4px 8px rgba(0,0,0,0.05); transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out; }
        .collapsible-panel:hover { transform: translateY(-5px); box-shadow: 0 8px 16px rgba(0,0,0,0.1); }
        .collapsible-header { background-color: #f4f7f9; padding: 10px 15px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .collapsible-header h3 { margin: 0; font-size: 1.1em; }
        .collapsible-content { padding: 15px; border-top: 1px solid #e0e0e0; display: none; }
        .collapsible-content .form-group { margin-bottom: 15px; }
        .collapsible-content .form-group label { font-weight: bold; margin-bottom: 5px; display: block; }
        .collapsible-content .form-group select { width: 100%; padding: 8px; font-size: 1em; }
        .form-row { display: flex; flex-wrap: wrap; gap: 20px; }
        .form-row .form-group { flex: 1 1 200px; margin-bottom: 0; }
        #column-selector { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; padding: 10px; background-color: #f9f9f9; border-radius: 4px; }
        #column-selector label { margin-bottom: 0; font-weight: normal; display: flex; align-items: center; }
        .backfill-buttons { display: flex; flex-wrap: wrap; gap: 10px; }
        .backfill-buttons button { flex: 1 1 auto; }
        .collapsible-content h4 { margin-top: 20px; margin-bottom: 10px; }
        .collapsible-content h5 { margin-top: 0; margin-bottom: 8px; color: #666; font-weight: 600; }
        .tool-group { margin-top: 15px; }
        .area-filter-buttons { display: flex; gap: 10px; flex-wrap: wrap; }
        .small-btn { padding: 6px 10px; font-size: 0.9em; color: white; border: none; border-radius: 4px; cursor: pointer; }
        .main-content { min-width: 0; }
        .scroll-hint { text-align: center; color: #888; font-style: italic; margin-bottom: 15px; }
        .trips-layout { display: flex; gap: 20px; align-items: flex-start; }
        .trips-list-container { flex: 1 1 60%; max-height: 70vh; overflow-y: auto; border: 1px solid #ddd; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.05); }
        .trips-list-container table { width: 100%; border-collapse: collapse; }
        .trips-list-container th { background-color: #f4f7f9; position: sticky; top: 0; z-index: 10; padding: 12px 15px; text-align: left; font-weight: 600; font-size: 0.85em; color: #333; text-transform: uppercase; border-bottom: 2px solid #00529b; vertical-align: middle; }
        .trips-list-container td { padding: 12px 15px; border-bottom: 1px solid #ddd; text-align: left; color: #555; vertical-align: middle; }
        .trips-list-container td[data-column="start-address"], .trips-list-container td[data-column="end-address"] { font-size: 0.9em; color: #777; line-height: 1.3; }
        .trips-list-container th.sortable { cursor: pointer; }
        .trips-list-container th.sortable:hover { background-color: #e9e9e9; }
        .trips-list-container .unit { font-size: 0.8em; color: #666; font-weight: normal; text-transform: none; }
        .trips-list-container tr:nth-child(even) { background-color: #f9f9f9; }
        .trips-list-container tbody tr:hover { background-color: #eef4f8; cursor: pointer; }
        .filter-indicator { color: #5cb85c; font-size: 0.8em; margin-left: 8px; font-weight: normal; display: none; }
        
        #map-panel { flex: 1 1 40%; position: sticky; top: 20px; display: none; }
        #map-panel-wrapper { background: #fff; border: 1px solid #ccc; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); overflow: hidden; }
        #map-panel-header { display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; padding: 10px 15px; background-color: #f4f7f9; border-bottom: 1px solid #ddd; }
        #map-panel-title { margin: 0; color: #00529b; font-size: 1.1em; }
        .map-nav-btn { display: none; }
        #close-map-panel-btn { background: none; border: none; font-size: 1.5em; cursor: pointer; color: #666; }
        #map { width: 100%; height: 500px; border: none; }
        #map-trip-stats { display: none; }
        .leaflet-draw-toolbar a { background-image: none !important; background-repeat: no-repeat !important; }

        #heatmap-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; display: none; align-items: center; justify-content: center; padding: 20px; }
        #heatmap-overlay-content { width: 95%; height: 95%; background: #fff; border-radius: 8px; display: flex; flex-direction: column; }
        #heatmap-overlay-header { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; background-color: #f4f7f9; border-bottom: 1px solid #ddd; }
        #heatmap-title { margin: 0; color: #00529b; font-size: 1.2em; }
        #close-heatmap-btn { background: none; border: none; font-size: 1.8em; cursor: pointer; color: #666; }
        #heatmap-map { flex-grow: 1; }
        #heatmap-loading { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white; font-size: 1.5em; display: none; }

        @media (max-width: 1024px) {
            .trips-layout { flex-direction: column; }
            #map-panel.is-overlay {
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.7); z-index: 1000;
                display: flex; align-items: center; justify-content: center;
                padding: 15px; flex-basis: auto; position: fixed;
            }
            .is-overlay #map-panel-wrapper { width: 100%; max-width: 800px; height: 90vh; max-height: 700px; display: flex; flex-direction: column; }
            .is-overlay #map-panel-content { flex-grow: 1; }
            .is-overlay #map { height: 100%; }
            .is-overlay .map-nav-btn {
                display: inline-block; padding: 5px 12px;
                background-color: #00529b; color: white;
                border: none; border-radius: 4px; cursor: pointer;
            }
            .is-overlay .map-nav-btn:disabled { background-color: #aaa; cursor: not-allowed; }
            .is-overlay #map-panel-title { flex-grow: 1; text-align: center; }
            .is-overlay #map-trip-stats {
                display: flex;
                justify-content: space-around;
                width: 100%;
                background: #e9ecef;
                padding: 8px 0;
                font-size: 0.8em;
                text-align: center;
                border-top: 1px solid #ddd;
                order: 3;
            }
            .is-overlay #map-trip-stats span { color: #555; }
            .is-overlay #map-trip-stats strong { color: #000; }
        }
    </style>
</head>
<body>
    <header class="main-header">
        <div class="header-title">MyToyota Dashboard</div>
        <nav class="main-nav">
            <a href="/" class="nav-link">
                <svg class="nav-icon" viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"></path></svg>
                <span>Dashboard</span>
            </a>
            <a href="/trips" class="nav-link active">
                <svg class="nav-icon" viewBox="0 0 24 24"><path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11C5.84 5 5.28 5.42 5.08 6.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.5 16c-.83 0-1.5-.67-1.5-1.5S5.67 13 6.5 13s1.5.67 1.5 1.5S7.33 16 6.5 16zm11 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5s-.67 1.5-1.5 1.5zM5 11l1.5-4.5h11L19 11H5z"></path></svg>
                <span>Trip History</span>
            </a>
            <a href="/notifications" class="nav-link">
                <svg class="nav-icon" viewBox="0 0 24 24"><path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.9 2 2 2zm6-6v-5c0-3.07-1.63-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.64 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2z"></path></svg>
                <span>Notifications</span>
            </a>
            <a href="/logs" class="nav-link">
                <svg class="nav-icon" viewBox="0 0 24 24"><path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"></path></svg>
                <span>Logs</span>
            </a>
            <a href="/settings" class="nav-link">
                <svg class="nav-icon" viewBox="0 0 24 24"><path d="M19.43 12.98c.04-.32.07-.64.07-.98s-.03-.66-.07-.98l2.11-1.65c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.3-.61-.22l-2.49 1c-.52-.4-1.08-.73-1.69-.98l-.38-2.65C14.46 2.18 14.25 2 14 2h-4c-.25 0-.46.18-.49.42l-.38 2.65c-.61-.25-1.17.59-1.69-.98l-2.49-1c-.23-.09-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64l2.11 1.65c-.04.32-.07.65-.07.98s.03.66.07.98l-2.11 1.65c-.19.15-.24-.42.12-.64l2 3.46c.12.22.39.3.61-.22l2.49-1c.52.4 1.08.73 1.69-.98l.38 2.65c.03.24.24.42.49.42h4c.25 0 .46-.18.49.42l.38-2.65c.61-.25 1.17-.59 1.69-.98l2.49-1c.23-.09.49 0 .61-.22l2-3.46c-.12-.22-.07-.49-.12-.64l-2.11-1.65zM12 15.5c-1.93 0-3.5-1.57-3.5-3.5s1.57-3.5 3.5-3.5 3.5 1.57 3.5 3.5-1.57 3.5-3.5 3.5z"></path></svg>
                <span>Settings</span>
            </a>
        </nav>
        <div class="header-extra"></div>
    </header>

    <div class="page-layout">
        <div class="controls-container">
            <div class="collapsible-panel">
                <div class="collapsible-header">
                    <h3>Options & Filters <span id="filter-status-indicator" class="filter-indicator"></span></h3>
                    <span class="toggle-indicator">&#9660;</span>
                </div>
                <div class="collapsible-content">
                    <div class="form-row">
                        <div class="form-group vin-selector">
                            <label for="vin-select">Select Vehicle:</label>
                            <select id="vin-select"></select>
                        </div>
                        <div class="form-group">
                            <label for="period-select">Display Period:</label>
                            <select id="period-select">
                                <option value="7">Last 7 Days</option>
                                <option value="30" selected>Last 30 Days</option>
                                <option value="90">Last 90 Days</option>
                                <option value="365">Last Year</option>
                                <option value="all">All Time</option>
                            </select>
                        </div>
                    </div>
                     <div class="form-group">
                        <h4>Filter by Country</h4>
                        <select id="country-select" multiple style="min-height: 100px;"></select>
                    </div>
                    <div class="form-group view-options">
                        <h4>Visible Columns</h4>
                        <div id="column-selector">
                            <label><input type="checkbox" data-column="start-time" checked> Start Time</label>
                            <label><input type="checkbox" data-column="end-time" checked> End Time</label>
                            <label><input type="checkbox" data-column="distance" checked> Distance</label>
                            <label><input type="checkbox" data-column="consumption" checked> Consumption</label>
                            <label><input type="checkbox" data-column="start-address" checked> Start Address</label>
                            <label><input type="checkbox" data-column="end-address" checked> End Address</label>
                            <label><input type="checkbox" data-column="duration"> Duration</label>
                            <label><input type="checkbox" data-column="avg-speed"> Avg. Speed</label>
                            <label><input type="checkbox" data-column="max-speed"> Max Speed</label>
                            <label><input type="checkbox" data-column="score-global"> Score (Global)</label>
                            <label><input type="checkbox" data-column="night-trip"> Night Trip</label>
                            <label><input type="checkbox" data-column="countries"> Countries</label>
                            <hr style="grid-column: 1 / -1; border-top: 1px solid #ccc; margin: 5px 0;">
                            <label><input type="checkbox" data-column="overspeed-dist"> Overspeed Dist.</label>
                            <label><input type="checkbox" data-column="overspeed-dur"> Overspeed Dur.</label>
                            <label><input type="checkbox" data-column="highway-dist"> Highway Dist.</label>
                            <label><input type="checkbox" data-column="highway-dur"> Highway Dur.</label>
                            <hr style="grid-column: 1 / -1; border-top: 1px solid #ccc; margin: 5px 0;">
                            <label><input type="checkbox" data-column="score-accel"> Score (Accel)</label>
                            <label><input type="checkbox" data-column="score-brake"> Score (Brake)</label>
                            <label><input type="checkbox" data-column="score-const"> Score (Const. Spd)</label>
                            <hr style="grid-column: 1 / -1; border-top: 1px solid #ccc; margin: 5px 0;">
                            <label><input type="checkbox" data-column="ev-dist"> EV Dist.</label>
                            <label><input type="checkbox" data-column="ev-dur"> EV Dur.</label>
                            <label><input type="checkbox" data-column="hdc-eco-dist"> Eco Dist.</label>
                            <label><input type="checkbox" data-column="hdc-eco-dur"> Eco Dur.</label>
                            <label><input type="checkbox" data-column="hdc-pwr-dist"> Power Dist.</label>
                            <label><input type="checkbox" data-column="hdc-pwr-dur"> Power Dur.</label>
                            <label><input type="checkbox" data-column="hdc-chg-dist"> Charge Dist.</label>
                            <label><input type="checkbox" data-column="hdc-chg-dur"> Charge Dur.</label>
                        </div>
                    </div>
                    <div class="form-group">
                        <h4>Analysis Tools</h4>
                        <div class="tool-group">
                            <h5>Filter by Area</h5>
                            <div class="area-filter-buttons">
                                <button id="filter-area-btn" class="small-btn" style="background-color: #5bc0de;">Area (Start/End)</button>
                                <button id="filter-start-area-btn" class="small-btn" style="background-color: #5cb85c;">Start Area</button>
                                <button id="filter-end-area-btn" class="small-btn" style="background-color: #337ab7;">End Area</button>
                            </div>
                             <div class="area-filter-buttons" style="margin-top: 10px;">
                                <button id="clear-area-filter-btn" class="small-btn" style="background-color: #d9534f; display: none;">Clear All Filters</button>
                            </div>
                            <div id="active-filters-display" style="font-size: 0.8em; color: #666; margin-top: 10px; min-height: 1.2em;"></div>
                        </div>
                        <div class="tool-group">
                            <h5>Visualization</h5>
                            <div class="area-filter-buttons">
                                <button id="show-heatmap-btn" class="small-btn" style="background-color: #f0ad4e;">Show Heatmap</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="collapsible-panel">
                <div class="collapsible-header">
                    <h3>Backfill Trip History</h3>
                    <span class="toggle-indicator">&#9660;</span>
                </div>
                <div class="collapsible-content">
                    <p style="font-size: 0.9em; color: #666;">Fetch trip summaries from the Toyota API for the selected vehicle.</p>
                    <div class="backfill-buttons">
                        <button data-period="week">Fetch Last Week</button>
                        <button data-period="month">Fetch Last Month</button>
                        <button data-period="year">Fetch Last Year</button>
                        <button data-period="all">Fetch All (can be slow)</button>
                    </div>
                    <p id="backfill-status-message" class="status-message"></p>
                </div>
            </div>
        </div>

        <main class="main-content">
            <div id="geocode-progress-container" style="display: none; margin-bottom: 15px;">
                <p>Geocoding in progress...</p>
                <progress id="geocode-progress-bar" max="100" value="0"></progress>
                <span id="geocode-progress-text"></span>
            </div>
            <p class="scroll-hint">Click a trip to see the map. The trip list is scrollable. Drag column headers to reorder.</p>
            <div class="trips-layout">
                <div class="trips-list-container">
                    <table>
                        <thead id="trip-table-headers">
                            <tr id="trip-table-header-row">
                            <th class="sortable" data-column="start-time" data-sort="start_timestamp">Start Time<span class="sort-indicator"></span></th>
                            <th data-column="end-time">End Time</th>
                            <th class="sortable" data-column="distance" data-sort="distance_km">Distance<span class="sort-indicator"></span><br><span class="unit" data-unit-type="distance">km</span></th>
                            <th class="sortable" data-column="consumption" data-sort="fuel_consumption_l_100km">Consumption<span class="sort-indicator"></span><br><span class="unit" data-unit-type="consumption">L/100km</span></th>
                            <th data-column="start-address">Start Address</th>
                            <th data-column="end-address">End Address</th>
                            <th class="sortable" data-column="duration" data-sort="duration_seconds">Duration<span class="sort-indicator"></span></th>
                            <th class="sortable" data-column="avg-speed" data-sort="average_speed_kmh">Avg. Speed<span class="sort-indicator"></span><br><span class="unit" data-unit-type="speed"></span></th>
                            <th class="sortable" data-column="max-speed" data-sort="max_speed_kmh">Max Speed<span class="sort-indicator"></span><br><span class="unit" data-unit-type="speed">km/h</span></th>
                            <th class="sortable" data-column="score-global" data-sort="score_global">Score<span class="sort-indicator"></span></th>
                            <th class="sortable" data-column="night-trip" data-sort="night_trip">Night Trip<span class="sort-indicator"></span></th>
                            <th data-column="countries">Countries</th>
                            <th class="sortable" data-column="overspeed-dist" data-sort="length_overspeed_km">Overspeed Dist.<span class="sort-indicator"></span><br><span class="unit" data-unit-type="distance">km</span></th>
                            <th class="sortable" data-column="overspeed-dur" data-sort="duration_overspeed_seconds">Overspeed Dur.<span class="sort-indicator"></span></th>
                            <th class="sortable" data-column="highway-dist" data-sort="length_highway_km">Highway Dist.<span class="sort-indicator"></span><br><span class="unit" data-unit-type="distance">km</span></th>
                            <th class="sortable" data-column="highway-dur" data-sort="duration_highway_seconds">Highway Dur.<span class="sort-indicator"></span></th>
                            <th class="sortable" data-column="score-accel" data-sort="score_acceleration">Score (Accel)<span class="sort-indicator"></span></th>
                            <th class="sortable" data-column="score-brake" data-sort="score_braking">Score (Brake)<span class="sort-indicator"></span></th>
                            <th class="sortable" data-column="score-const" data-sort="score_constant_speed">Score (Const.)<span class="sort-indicator"></span></th>
                            <th class="sortable" data-column="ev-dist" data-sort="ev_distance_km">EV Dist.<span class="sort-indicator"></span><br><span class="unit" data-unit-type="distance">km</span></th>
                            <th class="sortable" data-column="ev-dur" data-sort="ev_duration_seconds">EV Dur.<span class="sort-indicator"></span></th>
                            <th class="sortable" data-column="hdc-eco-dist" data-sort="hdc_eco_distance_km">Eco Dist.<span class="sort-indicator"></span><br><span class="unit" data-unit-type="distance">km</span></th>
                            <th class="sortable" data-column="hdc-eco-dur" data-sort="hdc_eco_duration_seconds">Eco Dur.<span class="sort-indicator"></span></th>
                            <th class="sortable" data-column="hdc-pwr-dist" data-sort="hdc_power_distance_km">Power Dist.<span class="sort-indicator"></span><br><span class="unit" data-unit-type="distance">km</span></th>
                            <th class="sortable" data-column="hdc-pwr-dur" data-sort="hdc_power_duration_seconds">Power Dur.<span class="sort-indicator"></span></th>
                            <th class="sortable" data-column="hdc-chg-dist" data-sort="hdc_charge_distance_km">Charge Dist.<span class="sort-indicator"></span><br><span class="unit" data-unit-type="distance">km</span></th>
                            <th class="sortable" data-column="hdc-chg-dur" data-sort="hdc_charge_duration_seconds">Charge Dur.<span class="sort-indicator"></span></th>
                        </tr>
                    </thead>
                        <tbody id="trips-table-body"></tbody>
                    </table>
                </div>
                <div id="map-panel">
                    <div id="map-panel-wrapper">
                        <div id="map-panel-header">
                            <button id="prev-trip-btn" class="map-nav-btn">&larr; Prev</button>
                            <h3 id="map-panel-title">Trip Map</h3>
                            <button id="next-trip-btn" class="map-nav-btn">Next &rarr;</button>
                            <button id="close-map-panel-btn">&times;</button>
                            <div id="map-trip-stats"></div>
                        </div>
                        <div id="map-panel-content">
                            <div id="map"></div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="heatmap-overlay">
        <div id="heatmap-overlay-content">
            <div id="heatmap-overlay-header">
                <h3 id="heatmap-title">Trips Heatmap</h3>
                <button id="close-heatmap-btn">&times;</button>
            </div>
            <div id="heatmap-map"></div>
            <div id="heatmap-loading">Loading Route Data...</div>
        </div>
    </div>

    <script src="/static/js/trips.js?v={{ cache_buster }}"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const collapsibleHeaders = document.querySelectorAll('.collapsible-header');
            collapsibleHeaders.forEach(header => {
                header.addEventListener('click', function() {
                    const content = this.nextElementSibling;
                    const indicator = this.querySelector('.toggle-indicator');
                    if (content.style.display === 'block') {
                        content.style.display = 'none';
                        indicator.innerHTML = '&#9660;';
                    } else {
                        content.style.display = 'block';
                        indicator.innerHTML = '&#9650;';
                    }
                });
            });
        });
    </script>
</body>
</html>