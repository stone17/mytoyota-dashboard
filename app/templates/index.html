<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyToyota Dashboard</title>
    <link rel="stylesheet" href="/static/css/style.css?v={{ cache_buster }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        #vehicle-container {
            display: grid;
            grid-template-columns: 1fr; /* Each vehicle gets its own row */
            gap: 20px;
        }
        .vehicle-wrapper {
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
            padding: 20px;
        }
        /* --- New Header Styles --- */
        .vehicle-header {
            display: flex;
            justify-content: space-between; /* Pushes title left, controls right */
            align-items: center;          /* Vertically aligns items */
            flex-wrap: wrap;              /* Allows controls to wrap below on small screens */
            gap: 10px 20px;               /* Adds space between items when they wrap */
            margin-bottom: 15px;          /* Space below the header */
        }
        .vehicle-controls {
            display: flex;
            align-items: center;
            gap: 15px;                    /* Space between button and last-updated text */
            flex-shrink: 0;               /* Prevents controls from shrinking oddly */
        }
        .last-updated {
            margin: 0; /* Remove default paragraph margin */
            font-size: 0.8em;
            color: #666;
            white-space: nowrap; /* Prevents "Last updated:" text from wrapping */
        }


        .panels-container {
            display: flex;
            flex-direction: row; /* Horizontal on desktop */
            gap: 20px;
            margin-bottom: 20px;
        }

        .panel {
            flex: 1;
            background: #f9f9f9;
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 15px;
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .panel:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
        }
        .panel .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #ddd;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }
        .panel .panel-header h3 {
            margin: 0;
            padding: 0;
            border: none;
        }
        .small-btn {
            padding: 4px 8px;
            font-size: 0.8em;
            background-color: #6c757d;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .small-btn:hover { background-color: #5a6268; }
        .small-btn:disabled { background-color: #aaa; cursor: not-allowed; }

        /* --- MODIFIED CSS FOR ROBUST GRID LINES --- */
        .vehicle-stats {
            display: grid;
            grid-template-columns: 1fr 1fr; /* Two-column layout */
            gap: 1px;                      /* This creates the grid lines */
            background-color: #e0e0e0;     /* This is the color of the grid lines */
            border: 1px solid #e0e0e0;     /* Keeps the outer border consistent */
            border-radius: 8px;
            overflow: hidden;              /* Clips children to the rounded corners */
            margin-bottom: 20px;
        }
        .stat {
            padding: 12px 15px;
            background-color: #fff; /* All cells have a solid background */
        }
        .stat h3 { margin: 0 0 4px 0; font-size: 0.8em; color: #666; text-transform: uppercase; }
        .stat p { margin: 0; font-size: 1.3em; font-weight: bold; }
        
        .charts { display: grid; grid-template-columns: 1fr; gap: 20px; }
        .charts { height: 350px; }

        .chart-controls {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            grid-template-rows: auto auto;
            gap: 4px 15px;
            margin-bottom: 15px;
        }
        .chart-controls label {
            grid-row: 1;
            font-weight: normal;
            font-size: 0.9em;
            color: #333;
        }
        .chart-controls .input-container {
             grid-row: 2;
        }
        .chart-controls .input-container, .chart-controls select {
            width: 100%;
        }
        .chart-controls .input-with-icon {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .chart-controls select {
            padding: 5px;
            border-radius: 4px;
            border: 1px solid #ccc;
        }

        .chart-icon-btn {
            background: none;
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 5px;
            cursor: pointer;
            height: 32px;
            width: 32px;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: border-color 0.2s;
        }
        .chart-icon-btn:hover {
            border-color: #333;
        }
        .chart-icon-btn svg {
            fill: #888;
            transition: fill 0.2s ease-in-out;
        }
        .chart-icon-btn.active svg {
            fill: #00529b;
        }


        .location-map-container {
            height: 250px;
            margin-top: 20px;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #ddd;
        }
        .location-map-container iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        .map-title {
            text-align: center;
            font-size: 1.1em;
            color: #333;
            margin-top: 25px;
            margin-bottom: 10px;
        }

        .vin { font-size: 0.8em; color: #999; text-align: center; margin-top: 20px; }

        .status-list { list-style: none; padding: 0; margin: 0; font-size: 0.9em; }
        .status-list li { display: flex; justify-content: space-between; align-items: center; padding: 8px 5px; border-bottom: 1px solid #f0f0f0; }
        .status-list li:last-child { border-bottom: none; }
        .status-icon { font-size: 1.4em; font-weight: bold; min-width: 25px; text-align: center; }
        .status-list li.open .status-icon { color: #d9534f; }
        .status-list li.closed .status-icon { color: #5cb85c; }
        .status-list li.locked .status-icon { color: #00529b; }
        .status-list li.unknown .status-icon { color: #aaa; }

        .lock-status-text { font-weight: normal; font-size: 0.9em; margin-left: 8px; }
        .lock-status-text.locked { color: #5cb85c; }
        .lock-status-text.unlocked { color: #d9534f; }
        .open-status-text {
            font-size: 0.9em;
            font-weight: bold;
            color: #d9534f;
            margin: -10px 0 15px 0;
            padding: 0 5px;
        }
        .status-timestamp {
            font-size: 0.8em;
            color: #888;
            margin: -10px 0 15px 5px;
            font-style: italic;
        }

        @media (max-width: 900px) {
            .panels-container {
                flex-direction: column;
            }
        }
        
        @media (max-width: 600px) {
            .vehicle-stats {
                grid-template-columns: 1fr; /* Single column layout for mobile */
            }
            .chart-controls {
                grid-template-columns: 1fr;
                grid-template-rows: repeat(6, auto);
                gap: 4px;
            }
            .chart-controls label { grid-row: unset; }
            .chart-controls .input-container { grid-row: unset; }

            .chart-controls label[for="chart-metric-left-axis"] { grid-row: 1; }
            .chart-controls .input-container.left-axis { grid-row: 2; }

            .chart-controls label[for="chart-metric-right-axis"] { grid-row: 3; }
            .chart-controls .input-container.right-axis { grid-row: 4; }

            .chart-controls label[for="chart-period-select"] { grid-row: 5; }
            .chart-controls .input-container.period { grid-row: 6; }
        }


        .summary-panel {
            background: #00529b;
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .summary-panel h2 {
            margin-top: 0;
            border-bottom: 1px solid rgba(255,255,255,0.3);
            padding-bottom: 10px;
        }
        .summary-stats {
            display: flex;
            justify-content: space-around;
            text-align: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        .summary-stat {
            flex: 1;
            min-width: 150px;
        }
        .summary-stat p {
            font-size: 2em;
            font-weight: bold;
            margin: 0;
        }
    </style>
</head>
<body>
    <header class="main-header">
        <div class="header-title">MyToyota Dashboard</div>
        <nav class="main-nav">
            <a href="/" class="nav-link active">
                <svg class="nav-icon" viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"></path></svg>
                <span>Dashboard</span>
            </a>
            <a href="/trips" class="nav-link">
                <svg class="nav-icon" viewBox="0 0 24 24"><path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11C5.84 5 5.28 5.42 5.08 6.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.5 16c-.83 0-1.5-.67-1.5-1.5S5.67 13 6.5 13s1.5.67 1.5 1.5S7.33 16 6.5 16zm11 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5s-.67 1.5-1.5 1.5zM5 11l1.5-4.5h11L19 11H5z"></path></svg>
                <span>Trip History</span>
            </a>
            <a href="/notifications" class="nav-link">
                <svg class="nav-icon" viewBox="0 0 24 24"><path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.9 2 2 2zm6-6v-5c0-3.07-1.63-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.64 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2z"></path></svg>
                <span>Notifications</span>
            </a>
            <a href="/logs" class="nav-link">
                <svg class="nav-icon" viewBox="0 0 24 24"><path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"></path></svg>
                <span>Logs</span>
            </a>
            <a href="/settings" class="nav-link">
                <svg class="nav-icon" viewBox="0 0 24 24"><path d="M19.43 12.98c.04-.32.07-.64.07-.98s-.03-.66-.07-.98l2.11-1.65c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.3-.61-.22l-2.49 1c-.52-.4-1.08-.73-1.69-.98l-.38-2.65C14.46 2.18 14.25 2 14 2h-4c-.25 0-.46.18-.49.42l-.38 2.65c-.61-.25-1.17.59-1.69-.98l-2.49-1c-.23-.09-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64l2.11 1.65c-.04.32-.07.65-.07.98s.03.66.07.98l-2.11 1.65c-.19-.15-.24-.42.12-.64l2 3.46c.12.22.39.3.61-.22l2.49-1c.52.4 1.08.73 1.69-.98l.38 2.65c.03.24.24.42.49.42h4c.25 0 .46-.18.49.42l.38-2.65c.61-.25 1.17-.59 1.69-.98l2.49-1c.23-.09.49 0 .61-.22l2-3.46c-.12-.22-.07-.49-.12-.64l-2.11-1.65zM12 15.5c-1.93 0-3.5-1.57-3.5-3.5s1.57-3.5 3.5-3.5 3.5 1.57 3.5 3.5-1.57 3.5-3.5 3.5z"></path></svg>
                <span>Settings</span>
            </a>
        </nav>
        <div class="header-extra"></div>
    </header>

    <main id="vehicle-container"></main>

    <template id="vehicle-template">
        <div class="vehicle-wrapper">
            <div class="vehicle-header">
                <div class="vehicle-title-group">
                    <h2 class="alias"></h2>
                    <p class="model-name"></p>
                </div>
                <div class="vehicle-controls">
                    <button class="small-btn force-poll">Refresh Data</button>
                    <p class="last-updated">Last updated: <span class="last-updated-time">Never</span></p>
                </div>
            </div>

            <div class="panels-container">
                <div class="panel stats-panel">
                    <div class="panel-header">
                        <h3>Current Statistics</h3>
                    </div>
                    <div class="vehicle-stats">
                        <div class="stat stat-odometer" data-stat-key="odometer">
                            <h3>Odometer</h3>
                            <p><span class="odometer">N/A</span></p>
                        </div>
                        <div class="stat stat-range" data-stat-key="range">
                            <h3>Range Left</h3>
                            <p><span class="total_range">N/A</span></p>
                        </div>
                        <div class="stat stat-ev-distance" data-stat-key="total_ev_distance">
                            <h3>Total EV Distance</h3>
                            <p><span class="total_ev_distance_km">N/A</span> (<span class="ev_ratio_percent">N/A</span>%)</p>
                        </div>
                        <div class="stat stat-fuel-level" data-stat-key="fuel_level">
                            <h3>Fuel Level (%)</h3>
                            <p><span class="fuel_level">N/A</span></p>
                        </div>
                        <div class="stat stat-daily-distance" data-stat-key="daily_distance">
                            <h3>Today's Distance</h3>
                            <p><span class="daily_distance">N/A</span></p>
                        </div>
                        <div class="stat stat-consumption" data-stat-key="consumption">
                            <h3>Consumption</h3>
                            <p><span class="overall_fuel_consumption">N/A</span></p>
                        </div>
                        <div class="stat stat-total-fuel" data-stat-key="total_fuel">
                            <h3>Total Fuel</h3>
                            <p><span class="total_fuel_l">N/A</span></p>
                        </div>
                        <div class="stat stat-duration" data-stat-key="duration">
                            <h3>Time Driven (h)</h3>
                            <p><span class="total_duration">N/A</span></p>
                        </div>
                        <div class="stat stat-ev-level" data-stat-key="ev_level">
                            <h3>EV Level</h3>
                            <p><span class="battery_level">N/A</span>%</p>
                        </div>
                        <div class="stat stat-ev-range" data-stat-key="ev_range">
                            <h3>EV Range (<span class="distance_unit">km</span>)</h3>
                            <p>
                                <span class="battery_range">N/A</span> 
                                <span class="battery_range_ac_span" style="font-size: 0.7em; color: #666;">
                                    (AC: <span class="battery_range_with_ac">N/A</span>)
                                </span>
                            </p>
                        </div>
                        <div class="stat stat-charging-status" data-stat-key="charging_status">
                            <h3>Charging</h3>
                            <p><span class="charging_status">N/A</span></p>
                        </div>
                        <div class="stat stat-max-speed" data-stat-key="max_speed">
                            <h3>Max Speed Ever</h3>
                            <p><span class="overall_max_speed">N/A</span></p>
                        </div>
                        <div class="stat stat-countries" data-stat-key="countries">
                            <h3>Countries Visited</h3>
                            <p><span class="all_countries">N/A</span></p>
                        </div>
                    </div>
                    <h3 class="map-title">Current Location of Car</h3>
                    <div class="location-map-container">
                        <p style="text-align: center; padding-top: 50px; color: #888;">Location data not available.</p>
                    </div>
                </div>

                <div class="panel charts-panel">
                    <div class="panel-header">
                        <h3>Historical Data <span class="trip-count"></span></h3>
                    </div>
                    <div class="chart-controls">
                        <label for="chart-metric-left-axis">Left Axis:</label>
                        <label for="chart-metric-right-axis">Right Axis:</label>
                        <label for="chart-period-select">Period:</label>
                        
                        <div class="input-container left-axis">
                            <div class="input-with-icon">
                                <select id="chart-metric-left-axis" class="chart-metric-select" data-axis="left">
                                    <option value="distance_km" selected>Distance</option>
                                    <option value="fuel_consumption_l_100km">Consumption</option>
                                    <option value="ev_distance_km">EV Distance</option>
                                    <option value="ev_duration_seconds">EV Duration</option>
                                    <option value="score_global">Driving Score</option>
                                    <option value="average_speed_kmh">Average Speed</option>
                                    <option value="max_speed_kmh">Max Speed</option>
                                    <option value="duration_seconds">Trip Duration</option>
                                </select>
                                <button class="chart-icon-btn histogram-toggle-btn" title="Toggle Histogram View">
                                    <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px">
                                        <path d="M0 0h24v24H0V0z" fill="none"/>
                                        <path d="M5 9.2h3V19H5zM10.6 5h2.8v14h-2.8zm5.6 8H19v6h-2.8z"/>
                                    </svg>
                                </button>
                            </div>
                        </div>

                        <div class="input-container right-axis">
                            <select id="chart-metric-right-axis" class="chart-metric-select" data-axis="right">
                                <option value="none" selected>None</option>
                                <option value="distance_km">Distance</option>
                                <option value="fuel_consumption_l_100km">Consumption</option>
                                <option value="ev_distance_km">EV Distance</option>
                                <option value="ev_duration_seconds">EV Duration</option>
                                <option value="score_global">Driving Score</option>
                                <option value="average_speed_kmh">Average Speed</option>
                                <option value="max_speed_kmh">Max Speed</option>
                                <option value="duration_seconds">Trip Duration</option>
                            </select>
                        </div>
                        
                        <div class="input-container period">
                             <select id="chart-period-select" class="chart-period-select">
                                <option value="7">Last 7 Days</option>
                                <option value="30" selected>Last 30 Days</option>
                                <option value="90">Last 90 Days</option>
                                <option value="365">Last Year</option>
                                <option value="all">All Time</option>
                            </select>
                        </div>
                    </div>
                    <div class="charts">
                        <canvas class="history-chart"></canvas>
                    </div>
                    <div class="chart-summary"></div>
                </div>

                <div class="panel status-panel">
                    <div class="panel-header">
                        <h3>Vehicle Status <span class="lock-status-text"></span></h3>
                    </div>
                    <p class="status-timestamp">Status as of: <span>N/A</span></p>
                    <p class="open-status-text"></p>
                    <ul class="status-list">
                        <li data-status-key="doors.front_left"><span>Front Left Door</span><span class="status-icon">N/A</span></li>
                        <li data-status-key="doors.front_right"><span>Front Right Door</span><span class="status-icon">N/A</span></li>
                        <li data-status-key="doors.rear_left"><span>Rear Left Door</span><span class="status-icon">N/A</span></li>
                        <li data-status-key="doors.rear_right"><span>Rear Right Door</span><span class="status-icon">N/A</span></li>
                        <li data-status-key="windows.front_left"><span>Front Left Window</span><span class="status-icon">N/A</span></li>
                        <li data-status-key="windows.front_right"><span>Front Right Window</span><span class="status-icon">N/A</span></li>
                        <li data-status-key="windows.rear_left"><span>Rear Left Window</span><span class="status-icon">N/A</span></li>
                        <li data-status-key="windows.rear_right"><span>Rear Right Window</span><span class="status-icon">N/A</span></li>
                        <li data-status-key="trunk"><span>Trunk</span><span class="status-icon">N/A</span></li>
                        <li data-status-key="hood"><span>Hood</span><span class="status-icon">N/A</span></li>
                    </ul>
                </div>
            </div>

            <p class="vin">VIN: <span>N/A</span></p>
        </div>
    </template>

    <script src="/static/js/main.js?v={{ cache_buster }}"></script>
</body>
</html>